  <!-- Data Container-->
  <div id="myAdminPanel" class="fixed-nav sticky-footer bg-dark">
    <div id="page-top">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <a class="navbar-brand" href="#">Fastfoods</a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav navbar-sidenav" id="exampleAccordion">
            <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Dashboard">
              <a class="nav-link" href="#">
                <i class="fa fa-fw fa-dashboard"></i>
                <span class="nav-link-text">Dashboard</span>
              </a>
            </li>
            <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Components">
              <a class="nav-link nav-link-collapse collapsed" data-toggle="collapse" href="#collapseComponents" data-parent="#exampleAccordion">
                <i class="fa fa-fw fa-wrench"></i>
                <span class="nav-link-text">Components</span>
              </a>
              <ul class="sidenav-second-level collapse" id="collapseComponents">
                <li>
                  <a href="#">Change Password</a>
                </li>
                <li>
                  <a href="#">Change Email</a>
                </li>
              </ul>
            </li>
          </ul>
          <ul class="navbar-nav sidenav-toggler">
            <li class="nav-item">
              <a class="nav-link text-center" id="sidenavToggler">
                <i class="fa fa-fw fa-angle-left"></i>
              </a>
            </li>
          </ul>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" id="btnLogOut">
                <i class="fa fa-fw fa-sign-out"></i>Logout</a>
            </li>
          </ul>
        </div>
      </nav>
      <div class="content-wrapper">
        <div class="container-fluid">
          <div id="addBlock"></div>
          <br><br>
          <!-- Breadcrumbs-->
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="#">Dashboard</a>
            </li>
            <li class="breadcrumb-item active">My Fastfoods Places</li>
          </ol>
          <!--DataTables Card-->
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-table"></i> Fastfood Places
              <a href="js/tmpl/add.html" id="addData" class="btn btn-success">Add New</a>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Address</th>
                      <th>Rating</th>
                      <th>Delete</th>
                      <th>Edit</th>
                    </tr>
                  </thead>
                  <tfoot>
                    <tr>
                      <th>Name</th>
                      <th>Address</th>
                      <th>Rating</th>
                      <th>Delete</th>
                      <th>Edit</th>
                    </tr>
                  </tfoot>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="card-footer small text-muted">Updated yesterday at 11:59 PM</div>
          </div>
        </div>
        <footer class="sticky-footer">
          <div class="container">
            <div class="text-center">
              <small>Copyright Â© Your Website 2018</small>
            </div>
          </div>
        </footer>
        <!-- Scroll to Top Button-->
        <a class="scroll-to-top rounded" href="#page-top">
          <i class="fa fa-angle-up"></i>
        </a>
      </div>
    </div>
  </div>

  <!--Places Container-->
  <div class="PlacesInfo hide">
      <div class="places-wrapper">
        <div class="container">
  
            <div id="result"></div>
  
            <template id="template">
              <h1 class="title">{{title}}</h1>
              <p class="address">{{address}}</p>
              <div class="rating">
                <select name="rating" id="ratingSel" class="custom-select">
                  <option selected>Rating:</option>
                  <option value="Any">Any</option>
                  <option value="Good">Good</option>
                  <option value="Bad">Bad</option>
                  <option value="Perfect">Perfect</option>
                </select>
              </div>
              <img class="image" src="{{img}}" alt="Food">
              <p class="info">
                <span>Few words about this place:</span><br>
                {{info}}</p>
              <div class="clearfix"></div>
              <progress value="0" max="100" id="uploader" class="hide">0%</progress>
              <input type="file" value="upload" id="fileButton" class='btn btn-info'>
            </template>
            <button id="Close" class='btn btn-info'>Close</button>
           
            
        </div>
      </div>
  </div>

  <script>
  (function($) {
    const base = firebase.database().ref('Fastfoods');
    const storage = firebase.storage();
    const table = $('#dataTable').DataTable({
            "autoWidth": false,
            "destroy": true,
            "columnDefs": [{
              "width": '3%',
              "targets": 3,
              "data": null,
              "defaultContent": "<button type='button' class='btn btn-danger delete'>Delete</button>"
            },{
              "width": '3%',
              "targets": 4,
              "data": null,
              "defaultContent": "<a href='#' class='btn btn-info edit'>See More</a>"
            }],
    });
    const app = new App();
    app.loadTable();

    function App(){
        // Draw firebase table
        this.loadTable = function(){
            base.on('child_added',function(snapshot) {
                let key = snapshot.key;
                let getData = [snapshot.child("name").val(), snapshot.child("address").val(), snapshot.child("rating").val()];
                let trBuild = table.rows.add([getData]).draw().nodes();
                $(trBuild).attr('data-key',key);
            });
        }

        // Realisation button "Add New"
        this.addNew = function(name,address){
            this.name = name;
            this.address = address;
            firebase.database().ref().child('Fastfoods').push({
                name: name,
                address: address,
                rating: "Any rating",
                info: 'Any info'
            });
        }

        // Realisation button "Delete"
        this.deleteData = function(data) {
            this.data = data;
            storage.ref(data).delete().then(function() {
                console.log('Delete complite!')
            }).catch(function(error) {
                console.log('Delete error!')
            });
            base.child(data).remove();
        };

        // Realisation button "Show more"
        $('#dataTable tbody').on( 'click', '.edit', function (e) {
            let that = this;
            //Show div with this info
            $(".PlacesInfo").removeClass('hide');

            //Get unique attribute for this data
            let data = $( that ).parent().parent().attr('data-key');

            //Get data of firebase by unique key(attribute);
            let thisData = base.child(data);
            //Get image of firebase storage

            //Listen all changes at this data
            let name = thisData.once("value").then(function(snapshot) {

                //We get the name and address using a unique key and write it in the "Show more" section and in the DOM
                var title = snapshot.child('name').val();
                var address = snapshot.child('address').val();
                var info = snapshot.child('info').val();
                var rating = snapshot.child('rating').val();
                

                var tmpl = $('#template').html();
                var compiled = Handlebars.compile(tmpl);
                var result = compiled({
                    title: title,
                    address: address,
                    info: info,
                    rating: rating,
                });
                $('#result').html(result);

                function downloadImage(){
                        storage.ref(data).getDownloadURL().then(function(url){
                            $('.image').attr('src', url);
                        });
                }
                downloadImage();
                //Changes for title and address
                $('.title').on('click', function(e){
                    let newTitle = dialog.prompt({
                        title: "New Name",
                        message: "Enter new name",
                        button: "Submit",
                        required: true,
                        input: {
                            type: "text",
                            placeholder: "New name..."
                        },
                        validate: function(value){
                            if( $.trim(value) === "" ){
                                return false;
                            }else{
                                thisData.update({
                                    name: value,
                                }); 
                                $('.title').html(value);
                                elem = $('[data-key='+data+'] td:eq(0)');
                                elem.html(value);
                            }
                          }
                    });  
                });
                $('.address').on('click', function(e){
                    let newAddress = dialog.prompt({
                        title: "New Address",
                        message: "Enter new address",
                        button: "Submit",
                        required: true,
                        input: {
                            type: "text",
                            placeholder: "New address..."
                        },
                        validate: function(value){
                            if( $.trim(value) === "" ){
                                return false;
                            }else{
                                thisData.update({
                                    address: value,
                                }); 
                                $('.address').html(value);
                                elem = $('[data-key='+data+'] td:eq(1)');
                                elem.html(value);
                            }
                          }
                    });
                });
                $('#ratingSel').on('change', function(e){
                    var newRating = $("#ratingSel").val();
                        thisData.update({
                            rating: newRating,
                        }); 
                        $('.rating').html("Rating: " + newRating);
                        elem = $('[data-key='+data+'] td:eq(2)');
                        elem.html(newRating);
                });
                $('.info').on('click', function(e){
                    let newInfo = dialog.prompt({
                        title: "New Info about place",
                        message: "Enter new info about this place",
                        button: "Submit",
                        required: true,
                        input: {
                            type: "text",
                            placeholder: "New info..."
                        },
                        validate: function(value){
                            if( $.trim(value) === "" ){
                                return false;
                            }else{
                                thisData.update({
                                    info: value,
                                }); 
                                $('.info').html(value);
                            }
                          }
                    });
                });
                $('#fileButton').on('change', function(e){
                    let file = e.target.files[0];
                    let storageRef = storage.ref(data);
                    let task = storageRef.put(file);
                    task.on('state_changed',
                    function progress(snapshot){
                        let percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        $('#uploader').val(percentage);
                    },
                    function error(err){
                        console.log('Upload image for this place.');
                    },
                    function complete(){
                        console.log('Complite!')
                        $('.image').attr('src', '');
                        downloadImage();
                    }
                );
                });
            });
            
        });

    }



    //Delete fastfood object
    $('#dataTable tbody').on( 'click', '.delete', function () {
        let that = $( this );
        let data = that.parent().parent().attr('data-key');
        dialog.confirm({
              title: "Delete place",
              message: "Do you want delete this place?",
              cancel: "Cancel",
              button: "Accept",
              required: true,
              callback: function(value){
                if(value == true){
                    app.deleteData(data);
                    table.rows(that.parents('tr')).remove().draw();
                }else{
                    return false;
                }
              }
            }); 
    });

    
    //Add a new fastfood object
    $('#addData').on('click', function(e){
        e.preventDefault();
        var href = $(this).attr('href');
        // Getting Content
        getContent(href, true);
       
        /* let newName = prompt('Enter the new name: ');
        let newAddress = prompt('Enter the new address: ');
        if((newName == "") || (newAddress == "") ||(newName == null) || (newAddress == null)){
            alert('You must enter all data!');
        }else{
            app.addNew(newName,newAddress);
        } */
    });

    $(document).on('click','#addCancel',function(e){
            e.preventDefault();
            var href = $(this).attr('href');
            getContent(href, true);
    });

    window.addEventListener("popstate", function(e) {
        getContent(location.pathname, false);
    });

    function getContent(url, addEntry) {
        $.get(url)
        .done(function( html ) {
            $('#addBlock').html(html);
            if(addEntry == true) {
                history.pushState(null, null, url);
            }
        });
    }

    //Close "Show more" window
    $('#Close').on( 'click', e => {
        e.stopPropagation();
        $(".PlacesInfo").addClass('hide');
        $('#fileButton').val('');
        $('#uploader').attr('value', '0');
    });

    //Button LogOut
    $('#btnLogOut').on('click', function(e) {
        console.log("logout");
        dialog.confirm({
            title: "Logout",
            message: "Do you want to exit?",
            cancel: "No",
            button: "Yes",
            required: true,
            callback: function(value){
              if(value == true){
                var _0x3132=["\x6A\x73\x2F\x74\x6D\x70\x6C\x2F\x6C\x6F\x67\x69\x6E\x2E\x68\x74\x6D\x6C"];
                let url=_0x3132[0];
                firebase.auth().signOut();
                $.get(url, function (data) {
                    $('#content').html(data);
                });
              }else{
                  return false;
              }
            }
          });
    });

})(jQuery);
  </script>

  